<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body id="body">
    
</body>

<!-- <script type="text/javascript" src="test.js"></script> -->

<!-- Attack idea: overwrite constant IP address in memory -->

<script type="text/javascript">


    let memory = new WebAssembly.Memory({initial: 50, maximum:100}); // page size (64kB)
    let table = new WebAssembly.Table({initial: 2, element:"anyfunc"});
    let stack_pointer = new WebAssembly.Global({value: "i32", mutable: true}, 100); // bytes


    const importObject = {
        env: {
            memory: memory,
            __memory_base: 0, // bytes or index?
            __table_base: 0, // starting index
            __indirect_function_table: table,
            __stack_pointer: stack_pointer, // bytes

            // Import JS functions to C code

            // Basic function for printing strings from linear memory
            print: function(pointer) {
                let decoder = new TextDecoder("utf8");

                // Find next null byte
                let array = new Uint8Array(memory.buffer);
                let end = array.indexOf(0, pointer);

                // Decode to utf8 text
                let js_string = decoder.decode(array.slice(pointer, end));
                console.log(js_string);
            }
        },
    };


    WebAssembly.instantiateStreaming(fetch("simple.wasm"), importObject).then(obj => {
        obj.instance.exports.main();
        console.log("--- MEMORY ---")
        console.log(memory);
    });


    // More complicated WASM (has libc + filesystem)
    // Wait for WASM runtime to load before using it
    // Module.onRuntimeInitialized = function() {
    //     _g();
    // }


    // JavaScript string someString can be converted to a char * using ptr = stringToNewUTF8(someString).
    // char * received from C/C++ can be converted to a JavaScript string using UTF8ToString().
    
</script>

</html>